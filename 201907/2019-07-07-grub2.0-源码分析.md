# grub2.0-源码分析



## 1. 目录结构分析

```shell
grub/grub-core/kern$ vim main.c
```

目录下的  main.c 源文件，实现了 grub 引导菜单主界面的用户交互功能；其中的 grub_main()，它是 main.c 的主函数，当我们看到 grub 的引导菜单主界面时，CPU 执行的正是这个函数中的代码逻辑；main.c 也就是编译后生成的 kernel.img 的核心部分；

```shell
grub/include/grub # 头文件
```

grub 源码目录的组织结构，采用下述规则来分离函数的声明，定义，以及调用：

grub/grub-core/kern/main.c  调用其它外部函数（没有在 main.c 中定义的）；

grub/grub-core/kern/  目录下的其它源文件，分别提供这些外部函数的定义（实现了这些函数的具体功能）；

另外， grub/grub-core/ 目录下的其它子目录，除了 kern 子目录外，有一些是 grub 2.00 的“模块”目录，例如 normal 子目录，loader 子目录等等，后面在代码中涉及具体源文件所在子目录时，再作介绍。

## 1. 编译

编译报错：

```shell
If this token and others are legitimate, please use m4_pattern_allow.
      See the Autoconf documentation.
```

```shell
sudo apt-get install libtool 
sudo apt-get install libsysfs-dev
```



## 2. 分析

### 2.1 main.c文件分析：

当我们看到　grub的引导界面，其实就是执行到这里了。

```c
/* The main routine.  */
void __attribute__ ((noreturn))
grub_main (void)
{
  /* First of all, initialize the machine.  */
  grub_machine_init (); 

  grub_boot_time ("After machine init.");

  /* Hello.  */
  /***
  	设置字体颜色
  */
  grub_setcolorstate (GRUB_TERM_COLOR_HIGHLIGHT);
  grub_printf ("Welcome to GRUB!\n\n");
  grub_setcolorstate (GRUB_TERM_COLOR_STANDARD);

  grub_load_config (); /*加载配置文件*/

  grub_boot_time ("Before loading embedded modules.");

  /* Load pre-loaded modules and free the space.  */
  grub_register_exported_symbols (); 
#ifdef GRUB_LINKER_HAVE_INIT
  grub_arch_dl_init_linker (); 
#endif  
  grub_load_modules (); 

  grub_boot_time ("After loading embedded modules.");

  /* It is better to set the root device as soon as possible,
     for convenience.  */
  grub_set_prefix_and_root (); 
  grub_env_export ("root");
  grub_env_export ("prefix");

  /* Reclaim space used for modules.  */
  reclaim_module_space (); 

  grub_boot_time ("After reclaiming module space.");

  grub_register_core_commands (); 

  grub_boot_time ("Before execution of embedded config.");

  if (load_config)
    grub_parser_execute (load_config);

  grub_boot_time ("After execution of embedded config. Attempt to go to normal mode");

  grub_load_normal_mode (); 
  grub_rescue_run (); 
}
```

# GRUB环境区块

https://blog.csdn.net/listener_ri/article/details/45621947

这个功能用来在一次引导时记录下一些信息，下一次启动 GRUB 可以读取这些信息。假设你希望默认菜  
 单项为最后一次使用的那个。你就需要使用这个。由于空间限制，为了节省代码量同时也是为了防止文  
 件系统崩溃，GRUB 不能写入文件。因此 GRUB 不能创建或者修改自己的配置文件。因此 GRUB 提供  
 了环境区块的功能，它用来记录 GRUB 当前的状态，便于日后加载。 

环境区块是一个 1024byte 的文件，它通常命名为 /boot/grub2/grubenv 。在 GRUB 中可以使用 load_  
 env 命令加载它，使用 save_env 写入当前 GRUB 环境变量到区块中。在 OS 中，可以使用 grub2-  
 editenv 程序编辑区块文件。 

由于安全问题，这个功能只能应用在普通磁盘（非 LVM 和 RAID ），不使用文件系统校检 （非 ZFS  
 ） ，使用 BIOS 或者 EFI( 非 ATA， USB 或者  IEEE1275 ) 的平台    。 

GRUB_SAVEDEFAULT  变量就是使用环境区块完成自己的功能。 