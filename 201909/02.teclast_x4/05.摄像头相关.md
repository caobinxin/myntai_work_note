# 1. 问题列表

1. 录像时，相机会断开连接
2. 后置相机，会连接到前置相机
3. 帧率慢，拍照慢

# 2. 问题解决

## 2.1 录像时相机断开：

### 2.1.1 问题定位

堆栈打印方法：

```cpp
// 把这个函数放在 文件的顶部，#include 的下面， 不然会报， namespace的问题 
    
#include <utils/Log.h>
#include <utils/CallStack.h>

void dumping_callstack(){
    android::CallStack stack;                                                  
    stack.update();
    stack.dump(1);
    stack.log("Dumping Stack", ANDROID_LOG_ERROR, "111111");
}

// E Dumping Stack: 111111111111111111111111111111111111111111111#00 pc 000c5999  /system/lib/libstagefright.so 
```

报错：

```shell
D CameraHardware: CameraHardware::getParameters
D CameraHardware: CameraHardware::putParameters
E CameraSource: Video dimension (1280x720) is unsupported
```

错误的原因：

```shell
1. 框架层中，将相机支持的所有分辨率都设置了，但是底层相机不一定支持这么多
2. 所以这里需要厂商去 适配 底层和上层要保持一致
```

台电x4 设备所支持的相机的分辨率为：

```shell
# 这些值是从底层上传上来的
CameraSource: configureCamera
CameraSource: colby........................................
CameraSource: isVideoSizeSupported # 在这个函数中打印出底层信息的
CameraSource:  colby supportedSizes[0] width=176 height=144 
CameraSource:  colby supportedSizes[1] width=240 height=160 
CameraSource:  colby supportedSizes[2] width=320 height=200 
CameraSource:  colby supportedSizes[3] width=320 height=240 
CameraSource:  colby supportedSizes[4] width=352 height=288 
CameraSource:  colby supportedSizes[5] width=432 height=320 
CameraSource:  colby supportedSizes[6] width=480 height=320 
CameraSource:  colby supportedSizes[7] width=1600 height=1200
```

上层相关配置的文件在 CamcorderProfile.java 中

```java
// CamcorderProfile.java
// 上层就是被设置为 1280*720 的了， 而底层相机不支持该分辨率的

	/** 
     * Quality level corresponding to the 720p (1280 x 720) resolution.
     */
    public static final int QUALITY_720P = 5
```



这里先将   Video dimension (1280x720) is unsupported 对应的调用栈打印出来在说：

```c++
// av/media/libstagefright/CameraSource.cpp:374

00 pc 000c5999  /system/lib/libstagefright.so -> CameraSource.cpp:52
01 pc 000c6245  /system/lib/libstagefright.so -> CameraSource.cpp:683
02 pc 000c4b81  /system/lib/libstagefright.so -> CameraSource.cpp:567
03 pc 000c4c5e  /system/lib/libstagefright.so -> CameraSource.cpp:205 -> CameraSource::CreateFromCamera 


04 pc 0015788f  /system/lib/libstagefright.so -> AVFactory.cpp:72 -> AVFactory::CreateCameraSourceFromCamera

05 pc 000574b2  /system/lib/libmediaplayerservice.so -> StagefrightRecorder.cpp:1500 -> 
    StagefrightRecorder::setupCameraSource // 在这个地方填充了 w h
    
06 pc 00055db6  /system/lib/libmediaplayerservice.so -> StagefrightRecorder.cpp:1465
07 pc 00053fad  /system/lib/libmediaplayerservice.so -> StagefrightRecorder.cpp:1742
08 pc 00053d9a  /system/lib/libmediaplayerservice.so -> StagefrightRecorder.cpp:812
09 pc 00054f38  /system/lib/libmediaplayerservice.so -> StagefrightRecorder.cpp:868
10 pc 0004dc24  /system/lib/libmediaplayerservice.so -> MediaRecorderClient.cpp:240
11 pc 000d6d83  /system/lib/libmedia.so -> IMediaRecorder.cpp:361
12 pc 000d73b1  /system/lib/libmedia.so 
13 pc 000390c6  /system/lib/libbinder.so
14 pc 000480c0  /system/lib/libbinder.so
15 pc 00047acb  /system/lib/libbinder.so
16 pc 0004831f  /system/lib/libbinder.so
17 pc 0006ef3e  /system/lib/libbinder.so
18 pc 00012095  /system/lib/libutils.so 
19 pc 00011883  /system/lib/libutils.so 
20 pc 00086e5f  /system/lib/libc.so 
21 pc 00022f40  /system/lib/libc.so 
22 pc 000207a6  /system/lib/libc.so
```

```c++
// frameworks$ vim av/media/libmediaplayerservice/StagefrightRecorder.cpp +1500

status_t StagefrightRecorder::setupCameraSource(
        sp<CameraSource> *cameraSource) {
       
    Size videoSize;
    videoSize.width = mVideoWidth; // 谁给他赋值为 7200了
    videoSize.height = mVideoHeight;
    if (mCaptureFpsEnable) {
    } else {
        *cameraSource = AVFactory::get()->CreateCameraSourceFromCamera(
                mCamera, mCameraProxy, mCameraId, mClientName, mClientUid, mClientPid,
                videoSize, mFrameRate,
                mPreviewSurface);
    }
........
}

status_t StagefrightRecorder::setVideoSize(int width, int height) {
    ALOGV("setVideoSize: %dx%d", width, height);
    if (width <= 0 || height <= 0) { 
        ALOGE("Invalid video size: %dx%d", width, height);
        return BAD_VALUE;
    }                      
    // Additional check on the dimension will be performed later
    mVideoWidth = width;
    mVideoHeight = height;
    
    // 在这个地方进行回溯

    return OK;
}
```

```shell
V StagefrightRecorder: setVideoSize: 1280x720
00 pc 000525b5  /system/lib/libmediaplayerservice.so -> StagefrightRecorder.cpp:71
01 pc 0004db82  /system/lib/libmediaplayerservice.so -> MediaRecorderClient.cpp:185
02 pc 000d6ff8  /system/lib/libmedia.so -> IMediaRecorder.cpp:442
03 pc 000d73b1  /system/lib/libmedia.so -> IMediaRecorder.cpp:323 -> BnMediaRecorder::onTransact # 到这里就需要跨进程通信了 

04 pc 000390c6  /system/lib/libbinder.so 
05 pc 000480c0  /system/lib/libbinder.so                     
06 pc 00047acb  /system/lib/libbinder.so 
07 pc 0004831f  /system/lib/libbinder.so 
08 pc 0006ef3e  /system/lib/libbinder.so 
09 pc 00012095  /system/lib/libutils.so 
10 pc 00011883  /system/lib/libutils.so 
11 pc 00086e5f  /system/lib/libc.so 
12 pc 00022f40  /system/lib/libc.so
13 pc 000207a6  /system/lib/libc.so
```

```cpp
// IMediaRecorder.cpp

status_t BnMediaRecorder::onTransact(
                                     uint32_t code, const Parcel& data, Parcel* reply,
                                     uint32_t flags)
{
    switch (code) {
            case SET_VIDEO_SIZE: {
            ALOGV("SET_VIDEO_SIZE");
            CHECK_INTERFACE(IMediaRecorder, data, reply);
            int width = data.readInt32();
            int height = data.readInt32();
            reply->writeInt32(setVideoSize(width, height));
            return NO_ERROR;
        } break;
    }
    ...
}

// 这个地方的 onTransact 是在这个地方被调用的：
status_t setVideoSize(int width, int height)
    {
        ALOGV("setVideoSize(%dx%d)", width, height);
        Parcel data, reply;
        data.writeInterfaceToken(IMediaRecorder::getInterfaceDescriptor());
        data.writeInt32(width);
        data.writeInt32(height);
        remote()->transact(SET_VIDEO_SIZE, data, &reply); // 这里被调用                             // 在这里进行 栈回溯                
        return reply.readInt32();
    }
```

回溯结果：

```c
V IMediaRecorder: setVideoSize(1280x720)
E Dumping Stack: 222222222222#00 pc 000000000012e47b  /system/lib64/libmedia.so -> IMediaRecorder.cpp:39

E Dumping Stack: 222222222222#01 pc 000000000013b5cd  /system/lib64/libmedia.so -> mediarecorder.cpp:322 -> MediaRecorder::setVideoSize
    
E Dumping Stack: 222222222222#02 pc 000000000004d4b9  /system/lib64/libmedia_jni.so -> android_media_MediaRecorder.cpp:288 // 看jni 的调用
    
    
E Dumping Stack: 222222222222#03 pc 0000000000ea254d  /data/dalvik-cache/x86_64/system@framework@boot.oat


```

```c++
// android_media_MediaRecorder.cpp

static void
android_media_MediaRecorder_setVideoSize(JNIEnv *env, jobject thiz, jint width, jint height)                                                                                                                       
{
    ALOGV("setVideoSize(%d, %d)", width, height);
    sp<MediaRecorder> mr = getMediaRecorder(env, thiz);

    if (width <= 0 || height <= 0) {
        jniThrowException(env, "java/lang/IllegalArgumentException", "invalid video size");
        return;
    }   
    process_media_recorder_call(env, mr->setVideoSize(width, height), "java/lang/RuntimeException", "setVideoSize failed."); // 在这里调用了
}

// 从这里我们可以看出， 这个函数是被java层调用了， java 层对应的函数为 setVideoSize(int, int)
static const JNINativeMethod gMethods[] = {
		{"setVideoSize",         "(II)V",                           (void 									*)android_media_MediaRecorder_setVideoSize},
}

int register_android_media_MediaRecorder(JNIEnv *env)
{
    return AndroidRuntime::registerNativeMethods(env,  
                "android/media/MediaRecorder", gMethods, NELEM(gMethods));
} // 这里是和 MediaRecorder.java 所对应的
```

```java
// MediaRecorder.java

public native void setVideoSize(int width, int height) throws IllegalStateException;

public void setProfile(CamcorderProfile profile) {
        setOutputFormat(profile.fileFormat);
        setVideoFrameRate(profile.videoFrameRate);
    
    	Log.e(“dump_test”,Log.getStackTraceString(new Throwable()));
    	// 在这个地方打印函数调用栈
        setVideoSize(profile.videoFrameWidth, profile.videoFrameHeight);// 从这里就要看， profile 文件是被谁设置的？？？                                                                                                                                     
        setVideoEncodingBitRate(profile.videoBitRate);
        setVideoEncoder(profile.videoCodec);
        if (profile.quality >= CamcorderProfile.QUALITY_TIME_LAPSE_LOW &&
             profile.quality <= CamcorderProfile.QUALITY_TIME_LAPSE_QVGA) {
            // Nothing needs to be done. Call to setCaptureRate() enables
            // time lapse video recording.
        } else {
            setAudioEncodingBitRate(profile.audioBitRate);
            setAudioChannels(profile.audioChannels);
            setAudioSamplingRate(profile.audioSampleRate);
            setAudioEncoder(profile.audioCodec);
        }
    }

// 这里我们发现 由原来的设置 w,h 变为设置 profile ，问题已经转变了
```

```shell
 make framework
```

```java
StagefrightRecorder: setVideoSource: 1
 java.lang.Throwable 
    at android.media.MediaRecorder.setProfile(MediaRecorder.java:484)
    at com.android.camera.VideoModule.initializeRecorder(VideoModule.java:1147)
    at com.android.camera.VideoModule.-wrap2(VideoModule.java)
    at com.android.camera.VideoModule$11.onStorageUpdateDone(VideoModule.java:1377)
    at com.android.camera.CameraActivity$20.onPostExecute(CameraActivity.java:2351)
    at com.android.camera.CameraActivity$20.onPostExecute(CameraActivity.java:2346)
    at android.os.AsyncTask.finish(AsyncTask.java:667)
    at android.os.AsyncTask.-wrap1(AsyncTask.java)
    at android.os.AsyncTask$InternalHandler.handleMessage(AsyncTask.java:684)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:154)
    at android.app.ActivityThread.main(ActivityThread.java:6300)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:887)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:777)
```

```java
// 这儿的1147 在 packages/apps/Camera2/src/com/android/camera/VideoModule.java:1147 中

 private void initializeRecorder() {
     ...
     mMediaRecorder.setCamera(camera);
        // CHAOZHUO BEGIN
        mMediaRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);
        // CHOAZHUO END
        mMediaRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);
        mMediaRecorder.setProfile(mProfile); // 这里就要着重分析这个是从那来的                                                                                                                                                                      
        mMediaRecorder.setVideoSize(mProfile.videoFrameWidth, mProfile.videoFrameHeight);
        mMediaRecorder.setMaxDuration(mMaxVideoDurationInMs);
     ...
 }

// 唯一一个被赋值的位置：
private void readVideoPreferences() {
    ...
    mProfile = CamcorderProfile.get(mCameraId, quality);
    ...
}
```

![](05.摄像头相关.assets/2019-09-23 18-55-26 的屏幕截图.png)

```shell
D CAM_VideoModule: Selected video quality for 'large' is 5                       
D CAM_VideoModule: 1.
D CAM_VideoModule: 5. mMaxVideoDurationInMs=0
D CAM_VideoModule: 7. quality=5
```

```shell
# int quality = SettingsUtil.getVideoQuality(videoQuality, mCameraId); // quality=5, 要着重去分析这个5 是从哪来的
```

