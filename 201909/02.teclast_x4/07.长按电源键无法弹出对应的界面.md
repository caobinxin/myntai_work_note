# 问题：

长按不弹出关机菜单

# 参考:

```shell
# 建峰给的参考

PhoneWindowManager -> interceptKeyBeforeDispatching
```

编译安装：

```shell
adb push ./out/target/product/x86_64/system/framework/services.jar /system/framework/services.jar
```



通过调试发现

```java
// com/android/server/policy/PhoneWindowManager.java
public int interceptKeyBeforeQueueing(){
    
}
```





先跟踪清楚　按键后屏幕熄灭的处理逻辑：

```java
native -> interceptKeyBeforeQueueing
	java-> interceptKeyBeforeQueueing()
    	-> interceptKeyBeforeQueueing() //PhoneWindowManager.java
```

```java
interceptKeyBeforeQueueing ->
	interceptPowerKeyDown(event, interactive);
```



短按：log 屏幕熄灭

```shell
D/powerbtn( 1413): type=1 scancode=116 value=1 from fd=4  

D/powerbtn( 1413): type=0 scancode=0 value=0 from fd=4

D/powerbtn( 1413): type=1 scancode=116 value=0 from fd=4

D/WindowManager( 3138): interceptKeyTq keycode=26 interactive=true keyguardActive=false policyFlags=22000000

I/PowerManagerSer( 3138): type=1400 audit(0.0:1781): avc: denied { ioctl } for path="/dev/dri/card0" dev="tmpfs" ino=10031 ioctlcmd=0x6409 scontext=u:r:system_server:s0 tcontext=u:object_r:device:s0 tclass=chr_f

D/powerbtn( 1413): type=0 scancode=0 value=0 from fd=4

D/WindowManager( 3138): interceptKeyTq keycode=26 interactive=true keyguardActive=false policyFlags=22000000

I/PowerManagerService( 3138): Going to sleep due to power button (uid 1000)...

I/PowerManagerService( 3138): Sleeping (uid 1000)...

W/IInputConnectionWrapper( 3679): requestCursorAnchorInfo on inactive InputConnection

W/FingerprintManager( 3250): isFingerprintHardwareDetected(): Service not connected!

D/iio-sensors( 3138): poll_activate: dev=0x7a8114179f00 handle=0 enabled=0

V/KeyguardServiceDelegate( 3138): onScreenTurnedOff()

D/LightsService( 3138): Excessive delay setting light: 208ms

E/PowerHAL( 3138): rmmod iwlwifi failed

D/PowerManagerService-JNI( 3138): Excessive delay in setInteractive(false) while turning screen off: 41ms

W/FingerprintManager( 3250): isFingerprintHardwareDetected(): Service not connected!
```

```shell
# 熄灭
/dev/input/event1: EV_KEY       KEY_POWER            DOWN                
/dev/input/event1: EV_SYN       SYN_REPORT           00000000            
/dev/input/event1: EV_KEY       KEY_POWER            UP                  
/dev/input/event1: EV_SYN       SYN_REPORT           00000000            
/dev/input/event17: EV_KEY       KEY_POWER            DOWN                
/dev/input/event17: EV_SYN       SYN_REPORT           00000000            
/dev/input/event17: EV_KEY       KEY_POWER            UP                  
/dev/input/event17: EV_SYN       SYN_REPORT           00000000 

# 唤醒
/dev/input/event1: EV_KEY       KEY_POWER            DOWN                
/dev/input/event1: EV_SYN       SYN_REPORT           00000000            
/dev/input/event1: EV_KEY       KEY_POWER            UP                  
/dev/input/event1: EV_SYN       SYN_REPORT           00000000            
/dev/input/event17: EV_KEY       KEY_POWER            DOWN                
/dev/input/event17: EV_SYN       SYN_REPORT           00000000            
/dev/input/event17: EV_KEY       KEY_POWER            UP                  
/dev/input/event17: EV_SYN       SYN_REPORT           00000000
```



长按：屏幕没变化

```shell
D/WindowManager( 3138): interceptKeyTq keycode=26 interactive=true keyguardActive=false policyFlags=22000000

D/WindowManager( 3138): interceptKeyTq keycode=26 interactive=true keyguardActive=false policyFlags=22000000
```

```shell
# 熄灭
/dev/input/event3: EV_MSC       MSC_SCAN             000000ce            
/dev/input/event3: EV_KEY       KEY_POWER            DOWN                
/dev/input/event3: EV_SYN       SYN_REPORT           00000000            
/dev/input/event3: EV_KEY       KEY_POWER            UP                  
/dev/input/event3: EV_SYN       SYN_REPORT           00000000 

#点亮
/dev/input/event1: EV_KEY       KEY_POWER            DOWN                
/dev/input/event1: EV_SYN       SYN_REPORT           00000000            
/dev/input/event1: EV_KEY       KEY_POWER            UP                  
/dev/input/event1: EV_SYN       SYN_REPORT           00000000            
/dev/input/event17: EV_KEY       KEY_POWER            DOWN                
/dev/input/event17: EV_SYN       SYN_REPORT           00000000            
/dev/input/event17: EV_KEY       KEY_POWER            UP                  
/dev/input/event17: EV_SYN       SYN_REPORT           00000000   
```



```shell
# /dev/input/event1

add device 1: /dev/input/event1
  bus:      0019
  vendor    0000
  product   0001
  version   0000
  name:     "Power Button"
  location: "PNP0C0C/button/input0"
  id:       ""
  version:  1.0.1
  events:
    KEY (0001): 0074 
  input props:
    <none>
    
 # /dev/input/event17
 
 add device 1: /dev/input/event17
  bus:      0000
  vendor    0000
  product   0000
  version   0000
  name:     "Android Power Button"
  location: ""
  id:       ""
  version:  1.0.1
  events:
    KEY (0001): 0074 
  input props:
    <none>
    
 # /dev/input/event3   
 add device 1: /dev/input/event3
  bus:      0019
  vendor    0000
  product   0000
  version   0000
  name:     "Intel HID 5 button array"
  location: ""
  id:       ""
  version:  1.0.1
  events:
    KEY (0001): 0072  0073  0074  007d  00f0  0231 
    MSC (0004): 0004 
  input props:
    <none>
```

event3 对应的kernel 驱动是：　drivers/platform/x86/intel-hid.c:325

```c
static void notify_handler(acpi_handle handle, u32 event, void *context)
{
    
}
```



