## 1. 说明

intel 直接给了一个 android 下 iwlwifi 的工程， 将这个工程 直接融合到我们的 phoenixos中即可。



## 2. 融合

### 2.1 修改 Android.mk

```diff
commit a8e4f46866b69deccc9d3fc823f9eea90d8f97a6
Author: colby <caobinxin@phoenixos.com>
Date:   Mon Nov 18 16:06:32 2019 +0800

    [phoenix] Compile to out/target/product/x86_64/iwlwifi
    
    Signed-off-by: colby <caobinxin@phoenixos.com>

diff --git a/Android.mk b/Android.mk
index adcd554..58d6945 100644
--- a/Android.mk
+++ b/Android.mk
@@ -1,6 +1,8 @@
 # including iwlwifi Android mk only if it was declared.
-ifeq ($(BOARD_USING_INTEL_IWL),true)
+BOARD_USING_INTEL_IWL := true
+INTEL_IWL_BOARD_CONFIG := iwlwifi
 
+ifeq ($(BOARD_USING_INTEL_IWL),true)
 # Run only this build if variant define the needed configuration
 # e.g. Enabling iwlwifi for XMM6321
 # BOARD_USING_INTEL_IWL := true      - this will enable iwlwifi building
@@ -14,19 +16,8 @@ INTEL_IWL_SRC_DIR := $(call my-dir)
 INTEL_IWL_OUT_DIR := $(abspath $(PRODUCT_OUT)/iwlwifi)
 INTEL_IWL_COMPAT_INSTALL_PATH ?= $(abspath $(TARGET_OUT))
 
-ifeq ($(CROSS_COMPILE),)
-ifneq ($(TARGET_TOOLS_PREFIX),)
-CROSS_COMPILE := CROSS_COMPILE=$(notdir $(TARGET_TOOLS_PREFIX))
-endif
-endif
-
-ifeq ($(CROSS_COMPILE),)
-ifeq ($(TARGET_ARCH),arm)
-$(warning You are building for an ARM platform, but no CROSS_COMPILE is set. This is likely an error.)
-else
-$(warning CROSS_COMPILE variant is not set; Defaulting to host gcc.)
-endif
-endif
+TARGET_ARCH := x86_64
+CROSS_COMPILE_VALUE := "/home/colby/sd_480/edu_tec_x4/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.15-4.8/bin/x86_64-linux-"
 
 ifeq ($(INTEL_IWL_USE_COMPAT_INSTALL),y)
 INTEL_IWL_COMPAT_INSTALL := iwlwifi_install
@@ -49,22 +40,25 @@ endif
 # IWLWIFI_CONFIGURE is a rule to use a defconfig for iwlwifi
 IWLWIFI_CONFIGURE := $(INTEL_IWL_OUT_DIR)/.config
 
-KERNEL_OUT_ABS_DIR := $(abspath $(KERNEL_OUT_DIR))
+#KERNEL_OUT_ABS_DIR := $(abspath $(KERNEL_OUT_DIR))
+KERNEL_OUT_ABS_DIR := "/home/colby/phoenixos_edu/out/target/product/x86_64/obj/kernel"
 
-iwlwifi: iwlwifi_build $(INTEL_IWL_COMPAT_INSTALL) $(INTEL_IWL_MOD_DEP)
+#iwlwifi: iwlwifi_build $(INTEL_IWL_COMPAT_INSTALL) $(INTEL_IWL_MOD_DEP)
+iwlwifi: iwlwifi_build 
 
 INTEL_IWL_SRC_FILES := $(shell find $(INTEL_IWL_SRC_DIR) -path $(INTEL_IWL_SRC_DIR)/.git -prune -o -print)
 $(INTEL_IWL_OUT_DIR): $(INTEL_IWL_SRC_FILES)
 	@echo Syncing directory $(INTEL_IWL_SRC_DIR) to $(INTEL_IWL_OUT_DIR)
 	@rsync -rt --del $(INTEL_IWL_SRC_DIR)/ $(INTEL_IWL_OUT_DIR)
 
-$(IWLWIFI_CONFIGURE): $(INTEL_IWL_KERNEL_DEPEND) $(INTEL_IWL_OUT_DIR)
+#$(IWLWIFI_CONFIGURE): $(INTEL_IWL_KERNEL_DEPEND) $(INTEL_IWL_OUT_DIR)
+$(IWLWIFI_CONFIGURE): $(INTEL_IWL_OUT_DIR)
 	@echo Configuring kernel module iwlwifi with defconfig-$(INTEL_IWL_BOARD_CONFIG)
-	@$(MAKE) -C $(INTEL_IWL_OUT_DIR)/ ARCH=$(TARGET_ARCH) $(CROSS_COMPILE) KLIB_BUILD=$(KERNEL_OUT_ABS_DIR) defconfig-$(INTEL_IWL_BOARD_CONFIG)
+	@$(MAKE) -C $(INTEL_IWL_OUT_DIR)/ ARCH=$(TARGET_ARCH) CROSS_COMPILE=$(CROSS_COMPILE_VALUE) KLIB_BUILD=$(KERNEL_OUT_ABS_DIR) defconfig-$(INTEL_IWL_BOARD_CONFIG)
 
 iwlwifi_build: $(IWLWIFI_CONFIGURE)
 	@$(info Building kernel module iwlwifi in $(INTEL_IWL_OUT_DIR))
-	@$(MAKE) -C $(INTEL_IWL_OUT_DIR)/ ARCH=$(TARGET_ARCH) $(CROSS_COMPILE) KLIB_BUILD=$(KERNEL_OUT_ABS_DIR)
+	@$(MAKE) -C $(INTEL_IWL_OUT_DIR)/ ARCH=$(TARGET_ARCH) CROSS_COMPILE=$(CROSS_COMPILE_VALUE) KLIB_BUILD=$(KERNEL_OUT_ABS_DIR)
 
 iwlwifi_install: iwlwifi_build $(INTEL_IWL_RM_MAC_CFG_DEPEND)
 	@$(info Installing kernel modules in $(INTEL_IWL_COMPAT_INSTALL_PATH))
```



当前的这个修改仅仅是





```shell
adb push ./net/wireless/cfg80211.ko /system/lib/modules/4.19.50-PhoenixOS-x86_64-ga5b79158b280-dirty/kernel/net/wireless/cfg80211.ko
adb push ./net/mac80211/mac80211.ko /system/lib/modules/4.19.50-PhoenixOS-x86_64-ga5b79158b280-dirty/kernel/net/mac80211/mac80211.ko
adb push ./drivers/net/wireless/intel/iwlwifi/xvt/iwlxvt.ko /system/lib/modules/4.19.50-PhoenixOS-x86_64-ga5b79158b280-dirty/kernel/drivers/net/wireless/intel/iwlwifi/xvt/iwlxvt.ko
adb push ./drivers/net/wireless/intel/iwlwifi/mvm/iwlmvm.ko /system/lib/modules/4.19.50-PhoenixOS-x86_64-ga5b79158b280-dirty/kernel/drivers/net/wireless/intel/iwlwifi/mvm/iwlmvm.ko
adb push ./drivers/net/wireless/intel/iwlwifi/iwlwifi.ko /system/lib/modules/4.19.50-PhoenixOS-x86_64-ga5b79158b280-dirty/kernel/drivers/net/wireless/intel/iwlwifi/iwlwifi.ko
adb push ./drivers/net/wireless/intel/iwlwifi/fmac/iwlfmac.ko /system/lib/modules/4.19.50-PhoenixOS-x86_64-ga5b79158b280-dirty/kernel/drivers/net/wireless/intel/iwlwifi/fmac/iwlfmac.ko
adb push ./drivers/net/wireless/intel/iwlwifi/dvm/iwldvm.ko /system/lib/modules/4.19.50-PhoenixOS-x86_64-ga5b79158b280-dirty/kernel/drivers/net/wireless/intel/iwlwifi/dvm/iwldvm.ko 
adb push ./drivers/net/wireless/mac80211_hwsim.ko /system/lib/modules/4.19.50-PhoenixOS-x86_64-ga5b79158b280-dirty/kernel/drivers/net/wireless/mac80211_hwsim.ko
adb push ./compat/compat.ko /system/lib/modules/4.19.50-PhoenixOS-x86_64-ga5b79158b280-dirty/kernel/compat/compat.ko
```

